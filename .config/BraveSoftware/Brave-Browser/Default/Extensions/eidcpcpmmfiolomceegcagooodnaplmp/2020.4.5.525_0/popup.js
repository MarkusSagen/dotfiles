let e,t,n,s={};function a(){if(function(){const e=(e,t)=>e.innerText=o((t||e.innerText).replace(/__MSG_(\w+)__/,"$1"));s.search=document.getElementById("search"),s.search.placeholder=o("placeholder_search"),e(document.getElementById("text-playback-rate")),e(document.getElementById("empty")),s["login-or-logout"]=document.getElementById("login-or-logout"),e(s["login-or-logout"].children[1],r()?"__MSG_login__":"__MSG_logout__"),setTimeout(t=>{for(const t of document.querySelectorAll("*"))!t.childElementCount&&t.innerText.match(/^__MSG_\w+__$/)&&e(t)},99)}(),!("chars_left"in e))return c(),void(e.state&&(f(),$(e.state).then(e=>{e?location.reload():k()})));e.isCognitoWasOpenedFromAnon&&(f(),$(U("email",e)).then(e=>{e?location.reload():k()})),function(){s={logo:document.getElementById("logo"),hamburger:document.getElementById("hamburger"),drawer:document.querySelector(".mdc-drawer"),upgrade:document.getElementById("upgrade"),listFeed:document.getElementById("list-feed"),addToFeed:document.getElementById("add-to-feed"),openFile:document.getElementById("open-file"),player:document.getElementById("player"),playPause:document.getElementById("play-pause"),prevChunk:document.getElementById("prev-chunk"),nextChunk:document.getElementById("next-chunk"),continuousPlaying:document.getElementById("continuous-playing"),playbackRateWrapper:document.getElementById("playback-rate-wrapper"),playbackRates:document.getElementsByName("playbackRate"),playbackRateLabels:document.getElementsByTagName("label"),snackbar:document.querySelector("intelligentspeaker--snackbar"),dialog:document.getElementById("mdc-dialog"),...s},e.id_token&&M(e).then(t=>{e=t,U("email",e).endsWith("@anonymous")?L(e.id_token):(!async function(e=0,t){const n=await fetch(`${I}history?updated=${e}`,{headers:{Authorization:t}}),a=await n.json();if(!a.Items)throw"_syncHistory: incorrect response from the backend?, resp_json:"+JSON.stringify(a);await Promise.all(a.Items.map(e=>(async function(e,t){const n=+[e.utc.N];if(e.is_deleted||await D(n))if(e.is_deleted){if(e.is_deleted){z(n);const e=document.getElementById(n);e&&e.remove()}}else!function(e,t,n,s){new Promise(a=>{indexedDB.open("intelligent-speaker").onsuccess=o=>{const i=o.target.result.transaction("articles","readwrite").objectStore("articles").get(e);i.onsuccess=o=>{o.target.result&&(void 0!==s?(o.target.result[t]||(o.target.result[t]=[]),o.target.result[t][s]=n):o.target.result[t]=n,o.target.source.put(o.target.result,e),a())},i.onerror=e=>void 0}})}(+e.utc.N,"isNew",e.isNew.BOOL),h(t=>[document.getElementById(e.utc.N)],t=>t.classList.toggle("new",e.isNew.BOOL));else E(n,e.favIconUrl?e.favIconUrl.S:"",e.url_article?e.url_article.S:"",e.title.S,!1,e.isNew&&e.isNew.BOOL,!1,e.hash_article.S,+e.len_chunks.N),chrome.runtime.sendMessage({fromPopup:"_cacheExisting",id:e.utc.N,hashArticle:e.hash_article.S,lenChunks:e.len_chunks.N,idToken:t}),s.listFeed.classList.remove("empty")})(e,t))),chrome.storage.sync.set({updated:Date.now()/1e3|0})}(e.updated,e.id_token),L(e.id_token,!0))});N(e=>{(e.url.match(/^https:\/\/(chrome.google.com\/webstore|addons.mozilla.org|addons.opera.com)/)||e.url.match(/^chrome|^about/))&&function(){s.addToFeed.classList.add("hidden")}()}),!0===e.isContinuousPlaying&&s.continuousPlaying.classList.add("true");s.playbackRateWrapper.querySelector(`[value="${e.playbackRate}"]`).checked=!0,setTimeout(t=>{!function(){if(s.avatar=document.getElementById("avatar"),s.avatarPlaceholder=document.getElementById("avatar-placeholder"),s.username=document.getElementById("username"),s.email=document.getElementById("email"),s.availableTime=document.getElementById("available-time"),e.id_token){const t=U("picture",e);if(t){if("{"===t[0]){const e=JSON.parse(t);e.data?s.avatar.src=e.data.url:s.avatar.src=e.source}else s.avatar.src=t;s.avatarPlaceholder.classList.add("hidden")}const n=U("given_name",e),a=U("family_name",e);s.username.innerText=[n,a].join(" ");const o=U("email",e);s.email.innerText=r()?"Anonymous account":o}else s.username.innerText="Anonymous";s.availableTime.innerText=(t=e.chars_left/F,`${t/60|0}h : ${t%60|0}m`);var t}()},99),e.isSubscribed?s.upgrade.classList.add("hidden"):s.upgrade.onclick=e=>S("pricing")}(),chrome.runtime.onMessage.addListener(e=>{if(e.toPopup){if(e.toPopup.isPreparingPlaying&&(s.playPause.disabled=!0,s.listFeed.classList.add("disabled")),e.toPopup.stillAddingToFeed&&e.toPopup.stillAddingToFeed.forEach(e=>{f();const t=e[0],n=e[1];document.getElementById(t)?document.getElementById(t).classList.add("addingToFeed"):E(t,n.favIconUrl,n.url,n.title,!0,!0)}),e.toPopup.playingStarted&&(s.listFeed.classList.remove("disabled"),s.playPause.disabled=!1,s.playPause.classList.add("playing"),document.getElementById(e.toPopup.audioCurrentFeedEntityId).classList.remove("new")),e.toPopup.audioCurrentFeedEntityId&&h(t=>[document.querySelector(".current"),document.getElementById(e.toPopup.audioCurrentFeedEntityId)],(t,n)=>{n.classList.add("current"),t&&t.id!==n.id&&t.classList.remove("current","playing"),!1===e.toPopup.isPaused?(n.classList.add("playing"),s.playPause.classList.add("playing")):e.toPopup.playingStarted&&n.classList.add("playing")}),e.toPopup.index>0?(s.prevChunk.disabled=!1,s.playPause.disabled=!1):"0"===e.toPopup.index&&(s.prevChunk.disabled=!0),!0===e.toPopup.hasNextChunk?(s.playPause.disabled=!1,s.nextChunk.disabled=!1):!1===e.toPopup.hasNextChunk&&(s.nextChunk.disabled=!0),e.toPopup.isPaused&&(h(e=>[document.querySelector(".current")],e=>e.classList.remove("playing")),s.playPause.classList.remove("playing")),!1===e.toPopup.isPaused&&s.playPause.classList.add("playing"),e.toPopup.playingFinished){const t=document.querySelector(".current");t&&(e.toPopup.removeStubFromFeed?t.remove():t.classList.remove("current","playing")),s.listFeed.classList.remove("disabled"),s.prevChunk.disabled=!0,s.playPause.disabled=!1,s.playPause.classList.remove("playing"),s.nextChunk.disabled=!0}e.toPopup.errorAddingToFeed&&(k(),h(e=>[document.querySelector(".addingToFeed")],e=>e.remove()),e.toPopup.reason&&v(e.toPopup.reason)),"addedToFeed"===e.toPopup&&(e.hashArticle&&v(o("snackbar_addedToFeed")),k(),h(e=>[document.querySelector(".addingToFeed")],e=>e.classList.remove("addingToFeed")),1===document.getElementsByClassName("item-feed").length&&(s.playPause.disabled=!1)),e.toPopup.cachedChunkId&&h(t=>{const n=document.getElementById(e.toPopup.cachedChunkId);return n?[n.querySelector(".tooltip")]:[]},t=>{if(isNaN(t.innerText[t.innerText.length-1])){const n=e.toPopup.lenChunks;n>1?t.innerText=o("tooltip_download_caching")+` 1 / ${n}`:(t.parentElement.classList.remove("processing"),t.innerText=o("tooltip_download"))}else{const n=e.toPopup.count;t.innerText=t.innerText.replace(/(\d+).+?(\d+)/,(e,s,a)=>{if(s<a-1)return`${n} / ${a}`;t.parentElement.classList.remove("processing");const i=o("tooltip_download");setTimeout(e=>t.innerText=i,0)})}}),e.toPopup.removeStub&&s.listFeed.firstElementChild.remove(),e.toPopup._fillListAudio&&_()}}),chrome.runtime.sendMessage({fromPopup:"getStatus"}),function(){if(s.emailPodcastLink=document.getElementById("email-podcast-link"),r())return void s.emailPodcastLink.remove();s.emailPodcastLink.onclick=function(){s.drawer.classList.remove("mdc-drawer--open"),s.settingsView.classList.remove("show"),this.disabled=!0,f(),M(e).then(e=>(function(e){fetch(`${x}send-email-podcast`,{headers:{Authorization:e.id_token,"Content-Type":"application/json"}}).then(e=>v(o("snackbar_podcastEmailSent"))).catch(e=>v(o("snackbar_error_podcastEmail"))).then(e=>{k()})})(e))}}(),function(){if(s.accountPageLink=document.getElementById("account-page-link"),r())return void s.accountPageLink.remove();s.accountPageLink.onclick=e=>S("account")}(),s.search.onkeyup=function(){const e=[],t=[];for(const n of s.listFeed.children)n.innerText.toLowerCase().includes(this.value.toLowerCase())?t.push(n):e.push(n);e.forEach(e=>e.classList.add("hidden")),t.forEach(e=>e.classList.remove("hidden")),_gaq.push(["_trackEvent","ui","search"])},s.logo.onclick=e=>S(),s.hamburger.onclick=function(){_gaq.push(["_trackEvent","ui","drawer"]),s.drawer.classList.add("mdc-drawer--open"),setTimeout(i,300)},s.drawer.onclick=function(e){e.target.classList.contains("mdc-drawer--temporary")&&this.classList.remove("mdc-drawer--open")},s.addToFeed.onclick=function(){s.listFeed.classList.remove("empty"),this.disabled=!0,N(e=>{chrome.tabs.detectLanguage(t=>{if("und"===t)return void v(o("snackbar_error_languageOfThePageIsUndefined"));if(!chrome.runtime.lastError&&!async function(e){return("/eventPage.html"===location.pathname?await _getPopupDOM():document).querySelectorAll(`[data-lang=${e}]`)}(t))return void v(o("languageNotSupported"));const n=w();chrome.runtime.sendMessage({fromPopup:"addToFeed",time:n,url:e.url,favIconUrl:e.favIconUrl,title:e.title,lang:t}),f(),E(n,e.favIconUrl,e.url,e.title,!0,!0)})}),_gaq.push(["_trackEvent","ui","addtofeed"])},s.openFile.onclick=function(){s.listFeed.classList.remove("empty");const e=document.querySelector("[type=file]");e.click(),e.onchange=function(){f();const e=this.files[0],t=w(),n={"text/plain":"https://intelligent-speaker.com/images/txt.svg","application/pdf":"https://intelligent-speaker.com/images/pdf.svg","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"https://intelligent-speaker.com/images/docx.svg"};if(E(t,n[e.type],"",e.name,!0,!0),"text/plain"===e.type){const s=new FileReader;s.readAsText(e,"UTF-8"),s.onload=s=>{const a=s.target.result;chrome.i18n.detectLanguage(a,s=>{chrome.runtime.sendMessage({time:t,title:e.name,favIconUrl:n[e.type],stringForVoicing:a,lang:s.languages[0].language})})}}else{const s=A()+"/"+e.name;fetch("https://input-files-for-tts.s3.amazonaws.com/"+s,{method:"PUT",headers:{"x-amz-acl":"bucket-owner-read"},body:e}).then(a=>{a.ok&&chrome.runtime.sendMessage({time:t,title:e.name,favIconUrl:n[e.type],prefix:s})}).catch(e=>{v(o("snackbar_error_file_load")),V("Error uploading file to S3: "+e.url+", status: "+e.status)})}},_gaq.push(["_trackEvent","ui","openfile"])},s.playPause.onclick=function(){if(this.classList.contains("playing")){chrome.runtime.sendMessage({fromPopup:"pause"}),this.classList.remove("playing");const e=document.querySelector(".current");e&&e.classList.remove("playing")}else document.getElementById("list-feed").children.length?(document.querySelector(".current img")||document.querySelector(".item-feed img")).click():(chrome.runtime.sendMessage({fromPopup:"resume"}),this.classList.add("playing"));this.blur(),_gaq.push(["_trackEvent","ui","playpause"])},s.prevChunk.onclick=function(){chrome.runtime.sendMessage({fromPopup:"prevChunk"}),s.playPause.classList.add("playing"),h(e=>[document.querySelector(".current")],e=>e.classList.add("playing")),_gaq.push(["_trackEvent","ui","prev"])},s.nextChunk.onclick=function(){chrome.runtime.sendMessage({fromPopup:"nextChunk"}),s.prevChunk.disabled=!1,s.playPause.classList.add("playing"),h(e=>[document.querySelector(".current")],e=>e.classList.add("playing")),_gaq.push(["_trackEvent","ui","next"])},s.continuousPlaying.onclick=function(){const e=this.classList.toggle("true");chrome.storage.sync.set({isContinuousPlaying:e}),chrome.storage.sync.get(["id_token","refresh_token"],t=>M(t).then(t=>P("isContinuousPlaying",e,t.id_token))),_gaq.push(["_trackEvent","ui","continuousplaying"])},s.listFeed.onclick=function(t){if(!this.classList.contains("disabled"))if(t.target.classList.contains("addingToFeed"))_gaq.push(["_trackEvent","ui","addingtofeed-item-disabled"]);else if("IMG"===t.target.tagName)if(t.target.parentElement.classList.contains("playing"))chrome.runtime.sendMessage({fromPopup:"pause"}),t.target.parentElement.classList.remove("playing"),s.playPause.classList.remove("playing"),_gaq.push(["_trackEvent","ui","item-pause"]);else{if(t.target.parentElement.classList.contains("addingToFeed"))return void _gaq.push(["_trackEvent","ui","addingtofeed-item-disabled"]);if(s.playPause.classList.add("playing"),t.target.parentElement.classList.contains("current"))chrome.runtime.sendMessage({fromPopup:"resume"}),t.target.parentElement.classList.add("playing");else{this.classList.add("disabled");const e=document.getElementsByClassName("current")[0];e&&e.classList.remove("current","playing");const n=t.target.parentElement.id;chrome.runtime.sendMessage({fromPopup:"playFromFeed",id:n},()=>{t.target.parentElement.classList.add("current","playing"),s.playPause.disabled=!0}),_gaq.push(["_trackEvent","ui","item-play"])}}else"A"===t.target.tagName?(_gaq.push(["_trackEvent","ui","item-openlink"]),chrome.tabs.create({url:t.target.innerText})):t.target.classList.contains("ico-download")?(isNaN(t.target.nextSibling.innerText[t.target.nextSibling.innerText.length-1])&&chrome.runtime.sendMessage({fromPopup:"downloadLocalOGGFromIndexedDB",id:t.target.parentElement.id}),_gaq.push(["_trackEvent","ui","item-download"])):t.target.classList.contains("ico-delete")?(function(e,t,...n){s.dialog.querySelector("header h2").innerText=o("delete")+"?",s.dialog.querySelector("section").innerText=e,s.dialog.querySelectorAll("button").forEach((e,s)=>{e.innerText=o(n[s]),e.onclick=s?t:y}),s.dialog.classList.add("mdc-dialog--open")}(t.target.parentElement.querySelector("a").innerText,n=>{y(),f(),async function(t){const{item:n,isUniqueForUser:a}=await function(e){return new Promise(t=>{indexedDB.open("intelligent-speaker").onsuccess=n=>{try{n.target.result.transaction("articles").objectStore("articles").get(e).onsuccess=n=>{const s=n.target.result;if(!s)throw"No item for id:"+e;n.target.source.openCursor().onsuccess=n=>{const a=n.target.result;a?(a.value.hashArticle===s.hashArticle&&a.key!==e&&t({item:s,isUniqueForUser:!1}),a.continue()):t({item:s,isUniqueForUser:!0})}}}catch(e){V("ERROR _prepareRemoving:")}}})}(t);M(e).then(i=>fetch(I+"articles/"+n.hashArticle+"?voice="+n.voice+"&lenChunks="+n.lenChunks+"&utc="+t+"&isUniqueForUser="+a,{method:"DELETE",headers:{Authorization:e.id_token}}).then(e=>{z(t),document.getElementById(t).remove(),document.getElementById("list-feed").children.length||(s.playPause.disabled=!0),v(o("snackbar_itemRemoved"))}).catch(e=>{v(o("snackbar_error_feedItemRemoving"))}).finally(e=>{k()})),document.getElementById(t).classList.contains("playing")&&chrome.runtime.sendMessage({fromPopup:"stopPlaying"})}(+t.target.parentElement.id)},"button_cancel","delete"),_gaq.push(["_trackEvent","ui","item-delete"])):t.target.parentElement.id.match(/\d+/)&&(function(t){const n=t.classList.toggle("new");chrome.runtime.sendMessage({fromPopup:"togglePlayedStatus",id_token:e.id_token,refresh_token:e.refresh_token,[t.id]:e[t.id],id:t.id,val:n})}(t.target.parentElement),_gaq.push(["_trackEvent","ui","item-toggleplayedstatus"]))},s.playbackRates.forEach(t=>t.onchange=function(){const t=+this.value;chrome.runtime.sendMessage({fromPopup:"alterPlaybackRate",value:t}),chrome.storage.sync.set({playbackRate:t}),M(e).then(e=>P("playbackRate",t,e.id_token)),_gaq.push(["_trackEvent","ui","playbackrate"])}),document.onkeydown=e=>{"Space"===e.code&&"search"!==document.activeElement.id&&(e.preventDefault(),s.playPause.click(),_gaq.push(["_trackEvent","ui","playpause-hotkey"]))},_gaq.push(["_setAccount","UA-105882536-1"])}function o(e,n){return n?t[e].message.replace(/\$(\w+)\$/,(s,a)=>n[t[e].placeholders[a].content.replace("$","")-1]):t[e].message}function i(){s.feedback=document.getElementById("feedback"),s.ideas=document.getElementById("ideas"),s.chat=document.getElementById("chat"),s.guide=document.getElementById("guide"),s.settingsButton=document.getElementById("settings-button"),s.settingsView=document.getElementById("settings-view"),s.backdrop=document.getElementById("mdc-dialog__backdrop"),s.languages=document.getElementById("languages");const t=e.id_token?U("email",e):"Anonymous";s.feedback.onclick=e=>{const n="https://docs.google.com/forms/d/e/1FAIpQLSdPh9fuy1P3zdbXO6knjCRrinzoKzTdRGu2wqdxvVIpZTblMw/viewform?usp=pp_url&entry.337702430&entry.2137746123="+t+"&entry.1853332692="+function(){let e=navigator.userAgent.match(/Chrome|OPR|Vivaldi|YaBrowser|Firefox/g).pop();return"OPR"===e&&(e="Opera"),e}();chrome.tabs.create({url:n})},s.ideas.onclick=e=>{const n="https://docs.google.com/forms/d/e/1FAIpQLSejGIENm_CEigc0cmIGW4-6xPVhgxLYxWqGRCNDortizEmS_g/viewform?usp=pp_url&entry.826480340&entry.968924808="+t;chrome.tabs.create({url:n})},s.chat.onclick=e=>{chrome.tabs.create({url:"https://www.facebook.com/messages/t/IntelligentSpeaker"})},s.guide.onclick=e=>{chrome.tabs.create({url:"https://www.youtube.com/watch?v=GkN1WQvXREU&list=PLiccyGSihaDdmcdYxLiUkxuCOe-9SnBRX"})},s.settingsButton.onclick=e=>{s.settingsView.classList.toggle("show"),s.settingsButton.classList.toggle("show"),document.querySelector("#settings-view #close").onclick=e=>{s.settingsView.classList.remove("show"),s.settingsButton.classList.remove("show")},_gaq.push(["_trackEvent","ui","settings"])},s.backdrop.onclick=function(){y()},s["login-or-logout"].onclick=t=>{r()?(chrome.storage.sync.set({isCognitoWasOpenedFromAnon:!0}),R(U("email",e))):(chrome.runtime.sendMessage({fromPopup:"stopPlaying"}),chrome.storage.sync.clear(),fetch("https://auth.intelligent-speaker.com/logout?client_id="+C+"&logout_uri=https://api.intelligent-speaker.com/logout",{mode:"no-cors"}),indexedDB.open("intelligent-speaker").onsuccess=e=>e.target.result.transaction("articles","readwrite").objectStore("articles").clear(),c(),chrome.runtime.sendMessage({fromPopup:"stopPlaying"}),_gaq.push(["_trackEvent","ui","logout"]))},function(){const t=e=>{Array.from(e.children).findIndex(e=>e.classList.contains("checked"))<10?e.style.top="20px":e.style.top="-280px"};!function(){const e=s.languages.querySelector("section"),a=e.querySelector(`[data-value=${n}`);a.classList.add("checked"),s.languages.dataset.text=a.innerText,t(e),s.languages.onclick=function(n){if("languages"!==n.target.id&&!this.classList.contains("open"))return;const a=this.classList.toggle("open");if(document.querySelectorAll(".multiselect").forEach(e=>e.classList.remove("open")),n.target.classList.contains("checked"))return;if(addEventListener("wheel",t=>{this.classList.contains("open")&&d(t,e)},{passive:!0}),n.stopPropagation(),window.onclick=n=>{this.classList.contains("open")&&(l(),t(e),s.settingsView.classList.remove("doNotScroll"))},a)return void s.settingsView.classList.add("doNotScroll");const o=n.target.dataset.value;chrome.storage.sync.get("lang",e=>{e.lang!==o&&(chrome.storage.sync.set({lang:o}),chrome.contextMenus.removeAll(),chrome.runtime.sendMessage({fromPopup:"buildContextMenu"}),_gaq.push(["_trackEvent","ui","languageui-change"]),location.reload())})}}(),document.getElementById("label-voice").onclick=e=>{e.target.classList.toggle("show")},chrome.storage.sync.get(e=>{for(const t of document.getElementsByClassName("multiselect")){const n=(e.voices||{})[t.dataset.lang];if(n){t.dataset.text=u(t,n),m(t,n);continue}const s=t.querySelector("div");t.dataset.text=s.innerText}}),document.getElementById("settings-view").onclick=e=>{if((!function(e){return e.dataset.voice}(e.target)&&!e.target.classList.contains("dropdown")||e.target.classList.contains("dropdown")&&!e.target.classList.contains("open"))&&l(),e.target.classList.contains("multiselect")){const t=e.target.children[0];t.style.top=e.y-15+"px",function(e,t){setTimeout(n=>{e.getBoundingClientRect().bottom+20>innerHeight&&(e.style.top=15+(e.clientHeight>t?0:t-e.clientHeight)+"px")},60)}(t,e.y),e.target.classList.add("open"),e.target.previousElementSibling.classList.add("highlight"),addEventListener("wheel",n=>{e.target.classList.contains("open")&&t.querySelectorAll("div").length>5&&d(n,t)},{passive:!0}),s.settingsView.classList.add("doNotScroll"),function(e){for(const t of e.querySelectorAll("div")){const n=t.dataset.voice;t.onclick=s=>{if(s.layerX>240)return g(t,n),void _gaq.push(["_trackEvent","ui","voice-preview"]);const a=t.classList.toggle("checked");p(s.target.parentElement.parentElement.dataset.lang,n,a,e),_gaq.push(["_trackEvent","ui","voice-change"])}}}(e.target)}},function(){const t=document.getElementById("breathing");!1===e.breathing&&t.classList.remove("on"),t.onclick=function(){const t=this.classList.toggle("on");chrome.storage.sync.set({breathing:t}),e.breathing=t,_gaq.push(["_trackEvent","ui","breath"])}}()}()}function r(){return!e.id_token||U("email",e).endsWith("@anonymous")}function c(){const e=document.getElementById("login");for(const e of document.body.getElementsByTagName("*"))e.style.display="none";e.innerText=o("login"),e.style.display="block",e.onclick=e=>{const t=A();chrome.storage.sync.set({state:t}),R(t)}}function l(){const e=document.querySelector(".dropdown.open");e&&(e.classList.remove("open"),e.previousElementSibling.classList.remove("highlight")),s.settingsView.classList.remove("doNotScroll")}function d(e,t){const n=innerHeight-t.offsetHeight-20,s=+t.style.top.replace("px",""),a=e.deltaY>0,o=e.deltaY<0;if(s>50&&o||s<n&&a)return;let i=s;0===e.deltaMode?i-=e.deltaY:1===e.deltaMode?i-=10*e.deltaY:2===e.deltaMode&&(i-=100*e.deltaY),i<n&&(i=n),i>50&&(i=50),requestAnimationFrame(e=>{t.style.top=i+"px"})}function u(e,t){return t.map(t=>e.querySelector(`[data-voice="${t}"]`).innerText.match(/: (.+)/)[1]).join(", ")}function m(e,t){t.forEach(t=>{e.querySelector(`[data-voice="${t}"]`).classList.add("checked")})}function g(e,t){let n=!1;s.playPause.classList.contains("playing")&&(n=!0,chrome.runtime.sendMessage({fromPopup:"pause"})),dispatchEvent(new Event("voicePreviewStarted"));const a=(t,s)=>{const a=new Audio(t);a.play(),e.classList.add("playing"),addEventListener("voicePreviewStarted",t=>{a.pause(),e.classList.remove("playing")}),a.onended=t=>{e.classList.remove("playing"),n&&setTimeout(e=>chrome.runtime.sendMessage({fromPopup:"resume"}),300),s&&chrome.runtime.sendMessage({fromPopup:"_cacheVoicePreview",id:s})}},o=e.parentElement.parentElement.dataset.lang,i=(e.dataset.locale||o)+"-"+t;D(i,"voice-preview").then(e=>{e?a(URL.createObjectURL(e.blob)):a(`https://intelligent-speaker.com/voice-preview/${i}.ogg`,i)})}function p(e,t,n,s){chrome.storage.sync.get(a=>{const o=a.voices||{},i=function(e){return"string"==typeof e?[e]:e}(o[e])||[];if(n)i.push(t);else{const e=i.findIndex(e=>e===t);i.splice(e,1)}s.dataset.text=u(s,i)||s.querySelector("div").innerText,i.length?o[e]=i:delete o[e],chrome.storage.sync.set({voices:o}),P("voices",o)})}function h(e,t){const n=e();n.some(e=>e)?t(...n):new MutationObserver((function(){const n=e();n.some(e=>e)&&(this.disconnect(),t(...n))})).observe(s.listFeed,{childList:!0})}function y(){s.dialog.classList.remove("mdc-dialog--open")}function f(){s.progress=document.getElementById("progress--this-is-some-random-id-name-that-do-not-collide-with-existing-id-in-dom"),s.progress.style.display="block",s.progress.firstElementChild.style.display="block",s.progress.classList.add("intelligentspeaker--active--please-do-not-collide")}function k(){s.progress.classList.remove("intelligentspeaker--active--please-do-not-collide")}function v(e){s.snackbar.innerText=e,s.snackbar.classList.add("intelligentspeaker--snackbar--class_active"),setTimeout(e=>s.snackbar.classList.remove("intelligentspeaker--snackbar--class_active"),5e3)}function _(){const t=t=>{const n=[],a=e=>{s.listFeed||(s.listFeed=document.getElementById("list-feed")),s.listFeed.append(...n)};t.forEach((t,s)=>{const a=function(t,n){if(n.cache&&n.lenChunks===n.cache.length)return;return setTimeout(s=>{chrome.runtime.sendMessage({fromPopup:"_cacheExisting",id:t,hashArticle:n.hashArticle,lenChunks:n.lenChunks,idToken:e.id_token})},1e3),` ${n.cache?n.cache.length:1} / ${n.lenChunks}`}(s,t);n.push(b(s,t.url,t.title,t.favIconUrl,!1,!1,t.isNew,a,t.isAddedOffline))}),["interactive","complete"].includes(document.readyState)?a():document.onreadystatechange=e=>{"interactive"===e.target.readyState&&a()}};j(0,8).then(e=>{if(!e.size)return document.getElementById("list-feed").classList.add("empty"),void(document.getElementById("play-pause").disabled=!0);s.listFeed||(s.listFeed=document.getElementById("list-feed")),s.listFeed.classList.remove("empty"),s.listFeed.innerHTML="",t(e),document.getElementById("play-pause").disabled=!1,j(8,9999999).then(e=>{e&&t(e)})})}function E(e,t,n,a,o=!1,i=!1,r=!1,c,l){s.listFeed.prepend(b(e,n,a,t,r,o,i));const d={favIconUrl:t,url:n,title:a,isNew:i,lenChunks:l};var u,m;c&&(d.hashArticle=c,d.lenChunks=l,u=e,m=d,new Promise((e,t)=>{indexedDB.open("intelligent-speaker").onsuccess=n=>{const s=n.target.result.transaction("articles","readwrite").objectStore("articles").put(m,u);s.onsuccess=e,s.onerror=e=>{V("Error put to IndexedDB:"+s.error),t()}}}))}function b(e,n,s,a="images/logo/logo-with-bigger-margin.png",i=!1,r=!1,c=!1,l="",d=!1){const u=document.createElement("li");u.id=e,u.classList.add("item-feed"),i&&u.classList.add("current","playing"),r&&u.classList.add("addingToFeed","new"),c&&u.classList.add("new"),d&&u.classList.add("isAddedOffline");const m=document.createElement("img");m.classList.add("favIcon"),a&&(m.src=a),u.appendChild(m);const g=document.createElement("div");g.classList.add("wrapper--url-and-title");const p=document.createElement("a");p.textContent=n,g.appendChild(p);const h=document.createElement("span");h.classList.add("title"),h.textContent=s.replace("<","&lt;"),g.appendChild(h),u.appendChild(g);const y=document.createElement("span");y.textContent="save_alt",y.classList.add("ico-download"),u.appendChild(y);const f=document.createElement("span");f.classList.add("tooltip"),u.appendChild(f);const k=document.createElement("span");k.textContent="delete",k.classList.add("ico-delete"),u.appendChild(k);const v=document.createElement("span");v.classList.add("tooltip"),u.appendChild(v);const _=e=>{f.textContent=r?o("tooltip_download_caching")+l:o("tooltip_download"),v.textContent=o("delete")};return t?_():addEventListener("messagesIsReady",_),u}function L(e,t=!1){fetch(`${I}user`,{headers:{Authorization:e}}).then(e=>e.json()).then(e=>{const n={};n.chars_left=e.CharsLeft,t&&(e.IsContinuousPlaying&&(n.isContinuousPlaying=e.IsContinuousPlaying),e.PlaybackRate&&(n.playbackRate=e.PlaybackRate),e.Voices&&(n.voices=e.Voices),"IsSubscribed"in e&&(n.isSubscribed=e.IsSubscribed)),chrome.storage.sync.set(n)})}function w(){const e=document.querySelector(".item-feed"),t=Date.now()/1e3|0;return e&&e.id==t?t+1:t}async function P(e,t,n){fetch(`${I}setting`,{method:"PUT",headers:{Authorization:n||(await M()).id_token,"Content-Type":"application/json"},body:JSON.stringify({[e]:t})})}function S(t=""){chrome.tabs.create({url:`https://intelligent-speaker.com/${t}/`+"?id_token="+e.id_token+"&refresh_token="+e.refresh_token})}_(),chrome.storage.sync.get(s=>{e=s,n=e.lang||function(){if("pt"===navigator.language)return"pt_PT";return navigator.language.slice(0,2)}(),function e(t,n){return fetch(chrome.runtime.getURL(`_locales/${t}/messages.json`)).then(e=>e.json()).then((function(e){return{messages:e,isFallback:n}})).catch(t=>e("en",!0))}(n).then(e=>{t=e.messages,dispatchEvent(new Event("messagesIsReady")),e.isFallback&&(n="en")}).then(a)});const x="https://mjqj47yt17.execute-api.us-east-1.amazonaws.com/test/",I="https://api.intelligent-speaker.com/",C="k44r81bdug8tm4721kbfuqbm5",B="722jaa8aarrubh9lc1v3ff2ibd",T="https://api.intelligent-speaker.com/cognito-callback",q="https://docs.google.com/forms/d/e/1FAIpQLSdDNyd3COJzZEw9sHXE34Y2Ercrq0klL1hCn0Or2mZapG7UQw/viewform?usp=pp_url&entry.1897026270&entry.523383874=",F=1040;function A(){return String(crypto.getRandomValues(new Uint32Array(3))).replace(/,/g,"")}function N(e){chrome.tabs.query({active:!0,currentWindow:!0},t=>{e:for(const n of t)if(n.url){e(n);break e}})}async function M(e,t=C){if(e||(e=await new Promise(e=>chrome.storage.sync.get(t=>e(t)))),!(U("exp",e)<(Date.now()/1e3|0)))return e;try{const n=await fetch("https://intelligentspeaker.auth.us-east-1.amazoncognito.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"grant_type=refresh_token&client_id="+t+"&refresh_token="+e.refresh_token}),s=await n.json();if("invalid_grant"===s.error)return M(e,B);const a={id_token:s.id_token};return chrome.storage.sync.set(a),{...e,...a}}catch(e){alert("Intelligent Speaker: error, try later"),stopPlaying()}}function R(e){chrome.tabs.create({url:"https://auth.intelligent-speaker.com/signup?response_type=code&client_id="+C+"&redirect_uri="+T+"&state="+e})}async function $(e){let t={};try{const n=await fetch(`${I}init`,{method:"POST",body:e});t=await n.json()}catch(e){throw alert("Intelligent Speaker: error, try later"),stopPlaying(),e}if(chrome.storage.sync.remove(["isCognitoWasOpenedFromAnon","state"]),!t)return;chrome.storage.sync.set({id_token:t.id_token,refresh_token:t.refresh_token,chars_left:t.chars_left,isContinuousPlaying:!!t.isContinuousPlaying,playbackRate:t.playbackRate||1,voices:t.voices,updated:Date.now()/1e3|0});const n=U("email",t);return chrome.runtime.setUninstallURL(q+n),"/eventPage.html"===location.pathname?(_initArticles(t.id_token,O(await j(),t.history)),t):(chrome.runtime.sendMessage({fromPopup:"_initArticles",id_token:t.id_token,history:O(await j(),t.history)}),t)}function O(e,t){return t.filter(t=>!e.get(t.utc))}function U(e,t){const n=t.id_token.split(".")[1].replace(/[_-]/g,"/");let s="";try{s=atob(n)}catch(e){throw`${e}, string for decoding: '${n}'`}return JSON.parse(s)[e]}function j(e=0,t=9999999){let n=0;const s=new Map;return new Promise(a=>indexedDB.open("intelligent-speaker").onsuccess=o=>o.target.result.transaction("articles").objectStore("articles").openCursor(null,"prev").onsuccess=o=>{const i=o.target.result;i?(n++>=e&&s.size<t&&s.set(i.key,i.value),i.continue()):a(s)})}function D(e,t="articles"){return new Promise(n=>{indexedDB.open("intelligent-speaker").onsuccess=s=>{const a=s.target.result;try{s.target.result.transaction(t).objectStore(t).get(e).onsuccess=e=>n(e.target.result)}catch(t){const n=Array.from(a.objectStoreNames);throw new Error(`getFromObjectStore(): ${t}, id:${e}, object stores:${n}`)}}})}function z(e){indexedDB.open("intelligent-speaker").onsuccess=t=>{const n=t.target.result;try{n.transaction("articles","readwrite").objectStore("articles").delete(e)}catch(t){const s=Array.from(n.objectStoreNames);throw`Removing article id:${e}, ex:${t}, object stores:${s}`}}}function V(e){chrome.storage.sync.get(t=>N(n=>{fetch(`${I}logextension`,{method:"POST",body:JSON.stringify({error:e,lang:String(window.lang),url:n.url,version:chrome.runtime.getManifest().version,storageCache:window.storageCache,storageSync:t}).replace(/["']/g,"'"),mode:"no-cors"})}))}window.onerror=(e,t,n,s,a)=>{let o="message:`"+e+"`";a&&a.stack&&(o+=", stacktrace:"+a.stack),V(o)},window.onunhandledrejection=e=>{const t="Message of rejected Promise:";if(e.reason.message){let n=t+e.reason.message;e.reason.stack&&(n+="`, stacktrace:"+e.reason.stack),V(n)}else V(t+"(reported from e.reason)"+e.reason)};